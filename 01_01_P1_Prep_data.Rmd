---
title: "R Notebook"
output: html_notebook
---



```{r}

library(tidyverse)
library(here)

```


## Prep original unimputed data

```{r}
# load original unimputed data
dat <- read.csv(here("data","processed", "data_all_atQbaseline.csv"))


# Create edu tertiles and grouped APOE

dat <- dat %>% 
  mutate(I_edu_tert = case_when(I_edu_VE %in% c(1,2,3,4) ~ "Low",
                                I_edu_VE %in% c(5) ~ "Medium",
                                I_edu_VE %in% c(6,7) ~ "High"), .after=I_edu_VE) %>% 
  mutate(APOE_grouped = case_when(APOE %in% c("E2E2", "E2E3") ~  "E2 positive",
                                  APOE %in% c("E4E4")         ~  "E4 homozygous",
                                  APOE %in% c("E3E4", "E2E4") ~  "E4 heterozygous",
                                  APOE %in% c("E3E3")         ~  "E4 negative" ), .after = APOE) %>% 
  mutate(APOE_e4 = case_when(APOE %in% c("E2E4","E3E4", "E4E4") ~ "E4 positive",
                             APOE %in% c("E2E2","E3E3", "E2E3") ~ "E4 negative"), .after = APOE)


# rename some diagnosis groups
dat <- dat %>% 
  mutate(D_Q_grouped = if_else(D_Q_grouped == "MovD", "CBS/PSP", D_Q_grouped),
         D_Q_grouped = if_else(D_Q_grouped == "Dem - other", "Dem other", D_Q_grouped),
         D_Q_grouped = if_else(D_Q_grouped == "Neuro - other", "Neuro other", D_Q_grouped))



# Make factors
dat <- dat %>%
  select(I_ID, I_age_q, I_sex, I_edu_VE, I_edu_tert, D_Q_grouped, APOE, APOE_e4, APOE_grouped, A_positive, 
         MMSE_q, Z_MEM, Z_EXEC,
         CAV_lifetime, CAV_past, CAV_current,
         FAV_total, CAV_response_rate, FAV_response_rate, ADsign_thick_unweighted, wholebrain_thick_weighted) %>% 
  mutate(I_sex        = factor(I_sex, 
                               levels=c("m","f"), labels=c("Male", "Female")),
         I_edu_tert   = factor(I_edu_tert,
                               levels = c("Low", "Medium", "High")),
         I_edu_VE     = factor(I_edu_VE),
         A_positive   = factor(A_positive),
         APOE         = factor(APOE, levels = c("E2E2", "E2E3", "E2E4", "E3E3", "E3E4", "E4E4")),
         APOE_grouped = factor(APOE_grouped,
                               levels = c("E2 positive", "E4 negative", "E4 heterozygous","E4 homozygous")),
         APOE_e4      = factor(APOE_e4, levels = c("E4 negative", "E4 positive")),
         D_Q_grouped  = factor(D_Q_grouped, 
                               levels=c("SCD", "MCI", "AD", "PPA", "FTD", "DLB", "CBS/PSP", "VaD", "Dem other","Neuro other", "Psych"))) %>% 
  rename(Age = I_age_q,
         Sex = I_sex,
         Edu_tert = I_edu_tert,
         Edu = I_edu_VE,
         Diagnosis = D_Q_grouped,
         MMSE = MMSE_q,
         MEM = Z_MEM,
         EXEC = Z_EXEC,
         CAV_lifetime = CAV_lifetime,
         CAV_past = CAV_past,
         CAV_current = CAV_current,
         FAV = FAV_total,
         ADsign_thick = ADsign_thick_unweighted,
         WB_thick = wholebrain_thick_weighted)


# Label columns
dat <- sjlabelled::var_labels(dat, 
                              Sex = "Sex",
                              Age = "Age",
                              Edu	 = "Education",
                              Edu_tert = "Education - tert",
                              CAV_lifetime = "Lifetime CAQ",
                              CAV_past = "Past CAQ",
                              CAV_current = "Current CAQ",
                              FAV = "PASE score",
                              MMSE = "MMSE",
                              MEM = "Memory",
                              EXEC = "Executive function",
                              APOE = "APOE genotype",
                              APOE_e4 = "APOE e4 status",
                              APOE_grouped = "APOE genotype",
                              A_positive = "Amyloid status",
                              Diagnosis = "Diagnosis",
                              CAV_response_rate = "CAQ response rate",
                              FAV_response_rate = "PASE response rate",
                              ADsign_thick = "AD signature thickness",
                              WB_thick = "Wholebrain thickness")


dat <- dat %>% 
  mutate(ADcont = if_else(Diagnosis %in% c("SCD", "MCI", "AD") & A_positive == "A+", 1, 0))

dat_ADcont <- dat %>% filter(ADcont == 1)

```


```{r}
# Save RDS object for analyses
saveRDS(dat, file = here("data", "processed", "Part1_dat_all.rds"))
saveRDS(dat_ADcont, file = here("data", "processed", "Part1_dat_ADcont.rds"))

```



## Prep imputed data

THe imputed mids object contains:
- CAV items
- FAV items
- Total scores passive
- Total scores directly imputes
- I_ID, age, sex
- Diagnosis, MMSE, MEM, EXEC, A_positive

- Edu VE --> need to tertile this
- APOE --> need to group this



```{r}

# load mids object
datmids <- readRDS(here("data", "processed", "Part1_mids_m40i100_allin.rds"))

# Prep imputed datasets
datimp <- complete(datmids, action="long", include = TRUE)


# Bring from the original datasets:
# CAV_response_rate, FAV_response_rate
# ADcont (variable whether on AD continuum)
datimp <- datimp %>% 
  left_join(., dat[,c("I_ID", "ADcont", "CAV_response_rate", "FAV_response_rate", "ADsign_thick", "WB_thick")], by="I_ID")


# Calculate final total scores
# If response_rate < 25%, take directly imputed total scores, otherwise take the passively imputed score
datimp <- datimp %>% 
  mutate(CAV_lifetime = if_else(CAV_response_rate < 0.25, CAV_lifetime, CAV_lifetime_passive),
         CAV_past     = if_else(CAV_response_rate < 0.25, CAV_past,     CAV_past_passive),
         CAV_current  = if_else(CAV_response_rate < 0.25, CAV_current,  CAV_current_passive),
         FAV_total    = if_else(FAV_response_rate < 0.25, FAV_total,    FAV_total_passive))


# Calculate edu tertiles and group APOE
datimp <- datimp %>% 
  mutate(I_edu_tert = case_when(I_edu_VE %in% c(1,2,3,4) ~ "Low",
                                 I_edu_VE %in% c(5) ~ "Medium",
                                 I_edu_VE %in% c(6,7) ~ "High")) %>% 
  mutate(APOE_grouped = case_when(APOE %in% c("E2E2", "E2E3") ~  "E2 positive",
                                  APOE %in% c("E4E4")         ~  "E4 homozygous",
                                  APOE %in% c("E3E4", "E2E4") ~  "E4 heterozygous",
                                  APOE %in% c("E3E3")         ~  "E4 negative" ), .after = APOE) %>% 
  mutate(APOE_e4 = case_when(APOE %in% c("E2E4","E3E4", "E4E4") ~ "E4 positive",
                             APOE %in% c("E2E2","E3E3", "E2E3") ~ "E4 negative"), .after = APOE)
  

# rename some diagnosis groups
datimp <- datimp %>% 
  mutate(D_Q_grouped = if_else(D_Q_grouped == "MovD", "CBS/PSP", D_Q_grouped),
         D_Q_grouped = if_else(D_Q_grouped == "Dem - other", "Dem other", D_Q_grouped),
         D_Q_grouped = if_else(D_Q_grouped == "Neuro - other", "Neuro other", D_Q_grouped))


# Make factors
datimp <- datimp %>%
  select('.imp', '.id', I_ID, I_age_q, I_sex, I_edu_VE, I_edu_tert, D_Q_grouped, APOE, APOE_e4, APOE_grouped, A_positive, 
         MMSE_q, Z_MEM, Z_EXEC, 
         CAV_lifetime, CAV_past, CAV_current,
         FAV_total, ADsign_thick, WB_thick) %>% 
  mutate(I_sex        = factor(I_sex, 
                               levels=c("m","f"), labels=c("Male", "Female")),
         I_edu_tert   = factor(I_edu_tert,
                               levels = c("Low", "Medium", "High")),
         I_edu_VE     = factor(I_edu_VE),
         A_positive   = factor(A_positive),
         APOE         = factor(APOE, levels = c("E2E2", "E2E3", "E2E4", "E3E3", "E3E4", "E4E4")),
         APOE_e4      = factor(APOE_e4, levels = c("E4 negative", "E4 positive")),
         APOE_grouped = factor(APOE_grouped,
                               levels = c("E2 positive", "E4 negative", "E4 heterozygous","E4 homozygous")),
         D_Q_grouped  = factor(D_Q_grouped, 
                               levels=c("SCD", "MCI", "AD", "PPA", "FTD", "DLB", "CBS/PSP", "VaD", "Dem other","Neuro other", "Psych"))) %>% 
  rename(Age = I_age_q,
         Sex = I_sex,
         Edu_tert = I_edu_tert,
         Edu = I_edu_VE,
         Diagnosis = D_Q_grouped,
         MMSE = MMSE_q,
         MEM = Z_MEM,
         EXEC = Z_EXEC,
         FAV = FAV_total)



# Center/scale variables

datimp <- datimp %>%
  group_by(.imp) %>%
  # center variables
  mutate(Age_c          = Age - mean(Age), .after=Age) %>%
  mutate(CAV_lifetime_c = CAV_lifetime - mean(CAV_lifetime, na.rm=TRUE), .after=CAV_lifetime) %>%
  mutate(CAV_current_c  = CAV_current - mean(CAV_current, na.rm=TRUE), .after=CAV_current) %>%
  mutate(CAV_past_c     = CAV_past - mean(CAV_past, na.rm=TRUE), .after=CAV_past) %>%
  mutate(FAV_c          = FAV - mean(FAV, na.rm=TRUE), .after=FAV) %>%
  mutate(MMSE_c         = MMSE - mean(MMSE, na.rm=TRUE), .after=MMSE) %>%
  mutate(MEM_c          = MEM - mean(MEM, na.rm=TRUE), .after=MEM) %>%
  mutate(EXEC_c         = EXEC - mean(EXEC, na.rm=TRUE), .after=EXEC) %>% 
  mutate(EXEC_c         = EXEC - mean(EXEC, na.rm=TRUE), .after=EXEC) %>% 
  mutate(ADsign_thick_c = ADsign_thick - mean(ADsign_thick, na.rm=TRUE), .after=ADsign_thick) %>% 
  mutate(WB_thick_c     = WB_thick - mean(WB_thick, na.rm=TRUE), .after=WB_thick) %>% 

  # scale variables
  mutate(Age_s          = (Age - mean(Age) )/sd(Age), .after=Age) %>%
  mutate(CAV_lifetime_s = (CAV_lifetime - mean(CAV_lifetime, na.rm=TRUE) )/sd(CAV_lifetime, na.rm=TRUE), .after=CAV_lifetime) %>%
  mutate(CAV_current_s  = (CAV_current - mean(CAV_current, na.rm=TRUE) )/sd(CAV_current, na.rm=TRUE), .after=CAV_current) %>%
  mutate(CAV_past_s     = (CAV_past - mean(CAV_past, na.rm=TRUE) )/sd(CAV_past, na.rm=TRUE), .after=CAV_past) %>%
  mutate(FAV_s          = (FAV - mean(FAV, na.rm=TRUE) )/sd(FAV, na.rm=TRUE), .after=FAV) %>%
  mutate(MMSE_s         = (MMSE - mean(MMSE, na.rm=TRUE) )/sd(MMSE, na.rm=TRUE), .after=MMSE) %>%
  mutate(MEM_s          = (MEM - mean(MEM, na.rm=TRUE) )/sd(MEM, na.rm=TRUE), .after=MEM) %>%
  mutate(EXEC_s         = (EXEC - mean(EXEC, na.rm=TRUE) )/sd(EXEC, na.rm=TRUE), .after=EXEC) %>%
  mutate(ADsign_thick_s = (ADsign_thick - mean(ADsign_thick, na.rm=TRUE) )/sd(ADsign_thick, na.rm=TRUE), .after=ADsign_thick) %>%
  mutate(WB_thick_s     = (WB_thick - mean(WB_thick, na.rm=TRUE) )/sd(WB_thick, na.rm=TRUE), .after=WB_thick) %>%
  ungroup()


datmids <- mice::as.mids(datimp)
  
```


```{r}
saveRDS(datmids, file = here("data", "processed", "Part1_datmids_all.rds"))

```


# Prep data for plotting

Take the median at the individual-level across the multiple imputed datasets for plotting purposed. 

```{r}

# Take the imputed sets only
datimp <- complete(datmids, action="long", include = FALSE)


# make one dataset with the median value across the imputed variables
dat_median <- datimp %>% 
  group_by(.id) %>% 
  select(.id, I_ID, Age, MMSE, MEM, EXEC, CAV_lifetime, CAV_past, CAV_current, 
         FAV, ADsign_thick, WB_thick) %>% 
  summarise_all(.funs = median)


# declare function to extract mode
calculate_mode <- function(x) {
  uniqx <- unique(x)
  uniqx[which.max(tabulate(match(x, uniqx)))] }


dat_mode <- datimp %>% 
  group_by(.id) %>% 
  select(.id, Sex, Edu, Edu_tert, Diagnosis, APOE_e4, APOE, APOE_grouped, A_positive) %>% 
  summarise_all(.funs = calculate_mode)


dat_median <- dat_median %>% 
  left_join(., dat_mode, by=".id")


# Center/scale variables

dat_median <- dat_median %>%
  # scale variables
  mutate(Age_s          = (Age - mean(Age) )/sd(Age), .after=Age) %>%
  mutate(CAV_lifetime_s = (CAV_lifetime - mean(CAV_lifetime) )/sd(CAV_lifetime), .after=CAV_lifetime) %>%
  mutate(CAV_current_s  = (CAV_current - mean(CAV_current) )/sd(CAV_current), .after=CAV_current) %>%
  mutate(CAV_past_s     = (CAV_past - mean(CAV_past) )/sd(CAV_past), .after=CAV_past) %>%
  mutate(FAV_s          = (FAV - mean(FAV) )/sd(FAV), .after=FAV) %>%
  mutate(MMSE_s         = (MMSE - mean(MMSE) )/sd(MMSE), .after=MMSE) %>%
  mutate(MEM_s          = (MEM - mean(MEM) )/sd(MEM), .after=MEM) %>%
  mutate(EXEC_s         = (EXEC - mean(EXEC) )/sd(EXEC), .after=EXEC) %>% 
  mutate(ADsign_thick_s = (ADsign_thick - mean(ADsign_thick, na.rm=TRUE) )/sd(ADsign_thick, na.rm=TRUE), .after=ADsign_thick) %>%
  mutate(WB_thick_s     = (WB_thick - mean(WB_thick, na.rm=TRUE) )/sd(WB_thick, na.rm=TRUE), .after=WB_thick)
  


# Label columns
dat_median <- sjlabelled::var_labels(dat_median,
                                     Sex = "Sex",
                                     Age = "Age",
                                     Age_s = "Age",
                                     Edu	 = "Education",
                                     Edu_tert = "Education - tert",
                                     CAV_lifetime = "Lifetime CAQ",
                                     CAV_lifetime_s = "Lifetime CAQ",
                                     CAV_past = "Past CAQ",
                                     CAV_past_s = "Past CAQ",
                                     CAV_current = "Current CAQ",
                                     CAV_current_s = "Current CAQ",
                                     FAV = "PASE score",
                                     FAV_s = "PASE score",
                                     MMSE = "MMSE",
                                     MMSE_s = "MMSE",
                                     MEM = "Memory",
                                     MEM_s = "Memory",
                                     EXEC = "Executive function",
                                     EXEC_s = "Executive function",
                                     APOE = "APOE genotype",
                                     APOE_e4 = "APOE e4 status",
                                     APOE_grouped = "APOE genotype",
                                     A_positive = "Amyloid status",
                                     Diagnosis = "Diagnosis")

```

```{r}
saveRDS(dat_median, file = here("data", "processed", "Part1_dat_median_all.rds"))

```

